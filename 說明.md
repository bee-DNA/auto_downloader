# 自動化下載器 - 使用說明

## 1. 專案簡介

本專案是一個自動化的 SRA 資料下載、解壓縮及上傳工具。它能從 NCBI 的 SRA 資料庫下載指定的樣本，使用 SRA Toolkit 將其解壓縮為 FASTQ 格式，最後將 SRA 和 FASTQ 檔案上傳到指定的 NAS 伺服器。

## 2. 主要功能

- **自動化流程**：從下載到上傳全程自動化，無需人工干預。
- **進度保存與恢復**：可隨時中斷程式，下次啟動時會從上次的進度繼續，不會重複下載。
- **錯誤處理**：單一樣本的失敗不會影響整體流程，失敗的樣本會被記錄下來。
- **並行處理**：充分利用多核心 CPU 資源，同時處理多個樣本以提高效率。
- **跨平台與容器化**：支援 Windows、Linux 本地端執行，並提供 Dockerfile，實現一鍵部署。
- **安全的憑證管理**：支援使用環境變數傳入 NAS 密碼，避免將密碼寫死在程式碼中。

## 3. 執行方式

### 方法一：使用 Docker (推薦)

這是最推薦的執行方式，可以忽略本機的環境差異，確保程式在一個乾淨、一致的環境中執行。

**前提：**

- 您的系統已安裝 [Docker](https://www.docker.com/get-started)。

**步驟：**

1.  **進入專案目錄**：
    打開終端機，`cd` 到本專案的根目錄（即 `Dockerfile` 所在的目錄）。

2.  **建立 Docker 映像檔**：
    執行以下指令來建立映像檔。此過程會自動下載 SRA Toolkit 並安裝所有依賴。

    ```bash
    docker build -t auto-downloader .
    ```

3.  **啟動與停止容器**

    您可以根據需求，選擇在前台（互動模式）或背景執行容器。

    - **選項 A：互動模式 (推薦初次使用)**
      此模式會直接在您的終端機顯示程式的即時輸出，方便您監控進度。按下 `Ctrl+C` 即可停止容器。容器停止後會自動刪除。

      - **Windows (PowerShell):**
        ```powershell
        docker run --rm -it -v "${PWD}:/app" -e NAS_PASS="您的NAS密碼" --name my-downloader auto-downloader
        ```
      - **Linux / macOS:**
        ```bash
        docker run --rm -it -v "$(pwd):/app" -e NAS_PASS="您的NAS密碼" --user "$(id -u):$(id -g)" --name my-downloader auto-downloader
        ```

    - **選項 B：背景模式 (適合長時間執行)**
      此模式會在背景執行容器，您的終端機可以繼續做其他事。您需要手動停止容器。

      - **啟動容器 (Windows - PowerShell):**
        ```powershell
        docker run -d -v "${PWD}:/app" -e NAS_PASS="您的NAS密碼" --name my-downloader auto-downloader
        ```
      - **啟動容器 (Linux / macOS):**
        ```bash
        docker run -d -v "$(pwd):/app" -e NAS_PASS="您的NAS密碼" --user "$(id -u):$(id -g)" --name my-downloader auto-downloader
        ```
      - **查看日誌:**
        ```bash
        docker logs -f my-downloader
        ```
      - **停止容器:**
        當您想停止背景執行的下載器時，執行以下指令：
        ```bash
        docker stop my-downloader
        ```

    **參數說明：**

    - `-it`：互動模式。
    - `-d`：背景模式。
    - `--rm`：容器停止後自動刪除，避免留下無用的容器。
    - `-v "${PWD}:/app"` (Windows) 或 `-v "$(pwd)":/app"` (Linux/macOS)：將目前的資料夾掛載到容器中，讓進度與下載的檔案可以被保存下來。
    - `-e NAS_PASS="..."`：安全地傳入您的 NAS 密碼。
    - `--name my-downloader`：為容器命名，方便後續管理 (例如停止或查看日誌)。
    - `--user "$(id -u):$(id -g)"` (Linux/macOS 適用)：確保容器寫入的檔案權限與您本機使用者一致，避免權限問題。

### 方法二：在本地端執行

**前提：**

- 已安裝 Python 3.7+。
- 已安裝 SRA Toolkit 並將其路徑加入系統環境變數 PATH (或者將其放在專案目錄下)。

**步驟：**

1.  **安裝 Python 套件**：

    ```bash
    pip install -r requirements.txt
    ```

2.  **設定 NAS 密碼**：

    - **Windows (PowerShell)**:
      ```powershell
      $env:NAS_PASS = "您的NAS密碼"
      ```
    - **Linux / macOS**:
      ```bash
      export NAS_PASS="您的NAS密碼"
      ```

3.  **執行程式**：
    - **Windows**:
      ```powershell
      .\START.ps1
      ```
    - **Linux / macOS**:
      ```bash
      python complete_downloader.py
      ```

## 4. 設定說明

- **`runs.txt`**：
  這是您的樣本清單。請將您要下載的所有樣本 ID (例如 `SRR123456`)，每行一個，填寫到這個檔案中。

- **`config.py`**：
  這個檔案包含了大部分的設定。雖然您可以直接修改，但更推薦透過環境變數來覆寫設定，特別是密碼。
  - `NAS_HOST`, `NAS_USER`, `NAS_PASS`：NAS 伺服器資訊。
  - `MAX_WORKERS`：同時處理的樣本數量。
  - `FASTERQ_THREADS`：每個樣本解壓縮時使用的執行緒數量。

## 5. 目錄結構

```
.
├── data/                  # 下載和解壓縮的暫存檔會存放在這裡
├── sratoolkit.3.2.1.../   # SRA Toolkit 工具包
├── complete_downloader.py # 主程式
├── config.py              # 設定檔
├── runs.txt               # 樣本清單
├── Dockerfile             # Docker 設定檔
└── 說明.md                # 本說明文件
```
