# 🚀 下載速度優化完成指南

## ✅ 已完成的優化

### 1. 配置優化（config.py）
- ✅ **MAX_WORKERS**: 4 → **8** (並行數加倍)
- ✅ **FASTERQ_THREADS**: 5 → **4** (減少單檔案資源競爭)
- ✅ **預期效果**: 5 Mbps × 8 = **40 Mbps 總吞吐量**

### 2. 下載程式優化（complete_downloader.py）
- ✅ 新增 `--progress` 旗標顯示即時進度
- ✅ 新增 `USE_ASPERA` 環境變數支援
- ✅ 自動偵測 Aspera 以獲得 10-100 倍加速

### 3. 新增診斷工具（optimize_download_speed.py）
- ✅ 網路速度測試
- ✅ Aspera 安裝檢查
- ✅ 優化建議指南

---

## 🔧 立即執行步驟

### 步驟 1: 重新建構 Docker 映像
```powershell
cd d:\OneDrive\學校上課\課程\四上\auto_downloader
docker build -t auto_downloader .
```
⏱️ 預計時間: 2-5 分鐘

---

### 步驟 2: 執行網路診斷（可選）
```powershell
python optimize_download_speed.py
```
這會測試你的網路速度並檢查 Aspera 安裝狀態。

---

### 步驟 3: 清理異常檔案
```powershell
python delete_extra_files.py
```
- 會讀取 `files_to_delete.txt`（39 個不完整檔案）
- 需要輸入 'yes' 確認刪除
- ⚠️ **建議先備份，但這些都是不完整的檔案**

---

### 步驟 4: 使用優化配置重新下載
```powershell
docker run --rm -v "${pwd}\data:/app/data" `
    -e RUNS_FILE=runs_to_fix.txt `
    -e MAX_WORKERS=8 `
    -e USE_ASPERA=yes `
    auto_downloader
```

**說明:**
- `RUNS_FILE=runs_to_fix.txt`: 只下載 42 個需要修復的樣本
- `MAX_WORKERS=8`: 8 個並行下載
- `USE_ASPERA=yes`: 如果已安裝 Aspera，自動使用

⏱️ **預計時間:**
- 使用標準連接（5 Mbps × 8）: ~4-6 小時
- 使用 Aspera（50-200 Mbps）: ~30-90 分鐘

---

### 步驟 5: 驗證完整性
下載完成後，再次執行驗證:
```powershell
python verify_and_fix_fastq.py
```

**預期結果:**
```
✅ 完整樣本: 896/896
❌ 不完整樣本: 0
❌ 缺失樣本: 0
```

---

## 💡 進階優化選項

### 選項 A: 進一步增加並行數（如果資源充足）
```powershell
docker run --rm -v "${pwd}\data:/app/data" `
    -e RUNS_FILE=runs_to_fix.txt `
    -e MAX_WORKERS=12 `
    auto_downloader
```
- **效果**: 5 × 12 = 60 Mbps
- **要求**: 更多 CPU 和記憶體

---

### 選項 B: 安裝 Aspera 獲得極速下載

#### 1. 下載 Aspera Connect
https://www.ibm.com/products/aspera/downloads

#### 2. 安裝後配置 SRA Toolkit
在 Docker 容器內執行:
```bash
vdb-config --interactive
```
- 進入 Main 選單
- 選擇 ASPERA
- 設定 Aspera 執行檔路徑

#### 3. 使用 Aspera 下載
```powershell
docker run --rm -v "${pwd}\data:/app/data" `
    -e RUNS_FILE=runs_to_fix.txt `
    -e USE_ASPERA=yes `
    auto_downloader
```

**預期速度**: 50-200 Mbps（**10-40 倍提升**）

---

### 選項 C: 夜間/離峰時段下載
NCBI 伺服器在美國，離峰時段可能更快:
- 🌙 **建議時段**: 台灣時間早上 6:00-12:00
- ⏰ **避開時段**: 台灣時間晚上 8:00-12:00

可使用 Windows 工作排程器設定自動下載:
```powershell
# 設定晚上 11 點自動執行
schtasks /create /tn "SRA_Download" /tr "powershell -File d:\path\to\start_download.ps1" /sc once /st 23:00
```

---

## 📊 效能比較

| 方案 | 單檔速度 | 並行數 | 總吞吐量 | 42 樣本預計時間 |
|------|---------|--------|----------|----------------|
| **原始設定** | 5 Mbps | 4 | 20 Mbps | ~10 小時 |
| **當前優化** | 5 Mbps | 8 | 40 Mbps | ~5 小時 |
| **增強並行** | 5 Mbps | 12 | 60 Mbps | ~3 小時 |
| **使用 Aspera** | 50-200 Mbps | 4-8 | 200-400 Mbps | ~30-60 分鐘 |

---

## ❓ 疑難排解

### Q1: Docker 建構失敗
```powershell
# 清理並重建
docker system prune -a
docker build --no-cache -t auto_downloader .
```

### Q2: 速度仍然很慢
1. 執行診斷工具: `python optimize_download_speed.py`
2. 檢查防火牆/防毒軟體
3. 嘗試有線網路
4. 考慮安裝 Aspera

### Q3: Aspera 安裝但未被使用
檢查環境變數是否正確:
```powershell
docker run --rm -v "${pwd}\data:/app/data" `
    -e USE_ASPERA=yes `
    auto_downloader `
    bash -c "echo \$USE_ASPERA && which ascp"
```

### Q4: 記憶體不足
減少並行數:
```powershell
docker run --rm -v "${pwd}\data:/app/data" `
    -e MAX_WORKERS=4 `
    auto_downloader
```

---

## 📝 檢查清單

下載前確認:
- [ ] Docker 映像已重新建構
- [ ] 異常檔案已清理（39 個）
- [ ] runs_to_fix.txt 存在（42 個樣本）
- [ ] 網路連接穩定
- [ ] 磁碟空間充足（至少 100 GB）

下載時監控:
- [ ] 觀察並行數是否正確（應該看到 8 個同時下載）
- [ ] 檢查 prefetch 進度顯示
- [ ] 監控 CPU 和記憶體使用率
- [ ] 記錄實際下載速度

下載後驗證:
- [ ] 執行 verify_and_fix_fastq.py
- [ ] 確認 896/896 完整
- [ ] 檢查檔案大小合理（_1 和 _2 應相近）
- [ ] 隨機抽查 2-3 個檔案完整性

---

## 🎯 預期結果

完成後，你應該有:
1. ✅ **896 個完整樣本**（每個有 _1.fastq 和 _2.fastq）
2. ✅ **0 個不完整或缺失樣本**
3. ✅ **總下載速度 40+ Mbps**
4. ✅ **所有檔案已上傳到 NAS**

---

## 🆘 需要協助？

如果遇到問題:
1. 查看 `download_progress.json` 錯誤訊息
2. 檢查 Docker 日誌: `docker logs <container_id>`
3. 執行診斷: `python optimize_download_speed.py`
4. 重新執行驗證: `python verify_and_fix_fastq.py`

**祝下載順利！🚀**
