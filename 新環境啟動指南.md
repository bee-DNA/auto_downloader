# 🆕 新環境啟動指南

## 📦 將系統移至新環境

### 1️⃣ 複製整個資料夾

將 `auto_downloader` 整個資料夾複製到新電腦：

```
✅ 壓縮為 ZIP（約 104 MB）
✅ 透過 USB 隨身碟傳輸
✅ 或透過網路複製
```

---

## 🚀 在新環境中啟動（完整流程）

### 步驟 1️⃣: 確認環境需求

#### ✅ 必須安裝（使用者需事先準備）

1. **Windows 作業系統**（Win10/11）

2. **Python 3.7 或以上版本**（⚠️ **需手動安裝**）

   ```powershell
   # 檢查Python版本
   python --version
   ```

   **如果沒有安裝 Python**:

   - 下載：https://www.python.org/downloads/
   - 推薦版本：Python 3.10、3.11 或 3.12
   - ⚠️ **安裝時務必勾選「Add Python to PATH」**
   - Python 3.13 也可以，但建議使用 3.10-3.12（更穩定）

3. **pip 套件管理器**（Python 通常會附帶）

   ```powershell
   # 檢查pip
   pip --version
   ```

4. **網路連線**
   - 用於下載 SRA 資料（NCBI）
   - 用於上傳至 NAS (bioailab.synology.me)

#### ✅ 磁碟空間需求

```
D:\sra_temp:      60 GB（SRA 暫存）
D:\tmp:          180 GB（FASTQ 暫存）
```

---

### 步驟 2️⃣: 安裝 SRA Toolkit（如果沒有）

**檢查是否已有 toolkit**:

```powershell
cd auto_downloader
dir sratoolkit.3.2.1-win64\bin\prefetch.exe
```

如果顯示「找不到」，需要安裝：

#### 方法 1: 自動安裝（推薦）

```powershell
# 一鍵安裝
一鍵安裝_SRA_Toolkit.bat

# 或使用 PowerShell 腳本
powershell -ExecutionPolicy Bypass -File 安裝_SRA_Toolkit.ps1
```

⏱️ 約 2-3 分鐘（會自動下載 60 MB）

#### 方法 2: 從 NCBI 手動下載

1. 下載：https://ftp-trace.ncbi.nlm.nih.gov/sra/sdk/3.2.1/sratoolkit.3.2.1-win64.zip
2. 解壓縮到 `auto_downloader` 資料夾內
3. 確認有 `sratoolkit.3.2.1-win64\bin\prefetch.exe`

---

### 步驟 3️⃣: 解除 SRA Toolkit 封鎖（重要！）

**⚠️ Windows 會封鎖從網路下載的檔案，必須先解除封鎖！**

```powershell
# 方法 1: 使用解除封鎖腳本（推薦）
powershell -ExecutionPolicy Bypass -File 解除封鎖_SRA_Toolkit.ps1

# 方法 2: 手動 PowerShell 指令
Get-ChildItem -Path .\sratoolkit.3.2.1-win64 -Recurse -File | Unblock-File
```

⏱️ 約 10 秒

**為什麼需要？**

- Windows 會將下載/複製的檔案標記為「不安全」
- 導致 `prefetch.exe` 無法執行
- 解除封鎖後才能正常運作

**💡 自動安裝腳本會自動解除封鎖**，如果您用方法 1 安裝，此步驟可跳過。

---

### 步驟 4️⃣: 執行 SETUP.bat（首次必須）

```powershell
.\SETUP.bat
```

**SETUP.bat 會自動完成**:

- ✅ 檢查 `download_progress.json` 和 `runs.txt`
- ✅ 統計樣本數量（606 個）
- ✅ **自動安裝 Python 套件**:
  - `paramiko`: SFTP 連接 NAS
  - `tqdm`: 進度條顯示
- ✅ 驗證本地 SRA Toolkit（已內建於此資料夾）
  - **如果無法執行**：自動嘗試解除封鎖
  - 如仍失敗：提示執行診斷工具
- ✅ 檢查環境完整性

⏱️ **需要時間**: 約 2-3 分鐘（首次安裝套件較慢）

**成功畫面**:

```
================================================================================
🔧 初始化自動下載系統
================================================================================

[1/4] 檢查必要檔案...
✅ download_progress.json 已存在
✅ runs.txt 已存在

[2/4] 統計樣本數量...
✅ runs.txt中的SRR樣本: 371 個

[3/4] 檢查Python環境與安裝套件...
✅ Python 3.11.0 已安裝

📦 安裝Python套件依賴...
⏳ 正在安裝 paramiko 和 tqdm...
✅ Python套件安裝完成
   - paramiko: SFTP上傳到NAS
   - tqdm: 進度條顯示

[4/4] 檢查SRA Toolkit...
✅ 使用本地 sratoolkit
   prefetch: 3.2.1
   fasterq-dump: 3.2.1

================================================================================
✅ 初始化完成！
================================================================================
```

---

### 步驟 5️⃣: 啟動下載

```powershell
.\START.bat
```

**系統會自動**:

- ✅ 連接 NAS 檢查已完成的 114 個樣本
- ✅ 下載剩餘的 **257 個樣本**（跳過 NAS 已有的 114 個）
- ✅ 6 個樣本並行處理（每個 5 線程 = 30 線程）
- ✅ 自動上傳 FASTQ 和 SRA 到 NAS
- ✅ 自動清理本地暫存檔

⏱️ **預計時間**: 約 28 小時（257 個樣本）

---

### 步驟 6️⃣: 監控進度

#### 方法 1: 查看終端輸出

```
🔄 [1/257] 處理 SRR12345678...
  ⏬ Prefetch: 2.5 GB | 進度: 45% | ETA: 10分鐘
  🧬 Fasterq-dump: 解壓中 (5線程)
  ☁️ 上傳 FASTQ: 5.2 GB | 進度: 80%
  ☁️ 上傳 SRA: 2.5 GB | 完成
  🗑️ 清理: 完成
✅ [1/257] 完成！ (總耗時: 1小時15分)
```

#### 方法 2: 檢查進度檔案

```powershell
notepad download_progress.json
```

找到最新的條目查看狀態：

```json
{
  "SRR12345678": {
    "status": "completed",
    "sra_uploaded": true,
    "fastq_uploaded": true,
    "completed_at": "2025-10-19T14:30:00"
  }
}
```

---

## 📋 Python 套件說明

### 核心套件（必須安裝）

#### 1. paramiko >= 3.0.0

- **用途**: SFTP 連接到群暉 NAS
- **功能**:
  - 上傳 FASTQ 檔案到 `/biodata_temp/raw_fastq/`
  - 上傳 SRA 檔案到 `/biodata_temp/raw_sra_backup/`
  - 檢查 NAS 已完成的檔案
- **必需**: ✅ 是

#### 2. tqdm >= 4.65.0

- **用途**: 顯示進度條
- **功能**: 顯示下載和上傳的即時進度
- **必需**: ⚠️ 推薦（沒有也能運作，但看不到進度條）

### 手動安裝指令

如果 SETUP.bat 安裝失敗，手動執行：

```powershell
# 安裝所有套件
pip install -r requirements.txt

# 或逐個安裝
pip install paramiko>=3.0.0
pip install tqdm>=4.65.0

# 升級已安裝的套件
pip install --upgrade paramiko tqdm
```

### 驗證安裝

```powershell
# 檢查套件是否安裝
python -c "import paramiko; print(f'paramiko {paramiko.__version__}')"
python -c "import tqdm; print(f'tqdm {tqdm.__version__}')"

# 或執行環境檢查腳本
python check_environment.py
```

---

## ⚙️ 系統配置

### 下載器配置（config.py）

```python
# NAS SFTP 設定
NAS_HOST = "bioailab.synology.me"
NAS_PORT = 10022
NAS_USERNAME = "guest_upload"
NAS_PASSWORD = "upload123"

# NCBI API Key（提升下載速度）
NCBI_API_KEY = "cbc34d71d57af75c93952af5d6b51d58d008"

# 線程設定
MAX_PARALLEL_SAMPLES = 6      # 同時處理 6 個樣本
THREADS_PER_SAMPLE = 5        # 每個樣本用 5 線程解壓
```

### 工作目錄

```
D:\sra_temp\         # SRA 檔案暫存（prefetch）
D:\tmp\              # FASTQ 檔案暫存（fasterq-dump）
```

---

## 🔍 故障排除

### 問題 1: Python 找不到

**錯誤**: `'python' 不是內部或外部命令...`

**解決**:

1. 確認已安裝 Python: https://www.python.org/downloads/
2. 安裝時勾選「Add Python to PATH」
3. 或手動加入 PATH 環境變數

---

### 問題 2: pip 安裝套件失敗

**錯誤**: `Could not find a version that satisfies...`

**解決**:

```powershell
# 更新 pip
python -m pip install --upgrade pip

# 再次安裝套件
pip install paramiko tqdm
```

---

### 問題 3: SRA Toolkit 找不到

**錯誤**: `prefetch.exe 無法執行`

**解決**:

1. 確認 `sratoolkit.3.2.1-win64` 資料夾存在於 `auto_downloader` 內
2. 檢查 `sratoolkit.3.2.1-win64\bin\prefetch.exe` 是否存在
3. 重新複製整個 `auto_downloader` 資料夾

---

### 問題 4: 無法連接 NAS

**錯誤**: `Connection refused` 或 `Authentication failed`

**檢查**:

1. 網路連線正常
2. NAS 地址正確: `bioailab.synology.me:10022`
3. 帳號密碼正確（在 `config.py` 中）
4. 防火牆沒有封鎖連接埠 10022

---

### 問題 5: 磁碟空間不足

**錯誤**: `No space left on device`

**解決**:

1. 清理 `D:\sra_temp\` 和 `D:\tmp\`
2. 確保 D: 磁碟至少有 240 GB 可用空間
3. 系統會自動清理完成的檔案

---

## 📊 預期結果

### 成功執行後

- ✅ **257 個樣本**下載並上傳到 NAS
- ✅ **114 個樣本**跳過（NAS 已有）
- ✅ **235 個樣本**跳過（ERR/DRR 非 SRR）
- ✅ 本地暫存自動清理
- ✅ `download_progress.json` 記錄所有進度

### 最終 NAS 結構

```
/biodata_temp/
├── raw_fastq/
│   ├── SRR12345678_1.fastq (5.2 GB)
│   ├── SRR12345678_2.fastq (5.2 GB)
│   └── ... (257 個樣本)
└── raw_sra_backup/
    ├── SRR12345678.sra (2.5 GB)
    └── ... (257 個樣本)
```

---

## 🎯 快速參考

| 步驟 | 指令                             | 說明                          |
| ---- | -------------------------------- | ----------------------------- |
| 1    | `.\SETUP.bat`                    | 首次啟動，安裝套件            |
| 2    | `.\START.bat`                    | 開始下載（跳過 114 個已完成） |
| 3    | 查看終端                         | 監控即時進度                  |
| 4    | `notepad download_progress.json` | 檢查詳細進度                  |
| 5    | `python check_environment.py`    | 驗證環境                      |

---

## ℹ️ 重要提醒

### 下載策略

✅ **只下載 NAS 沒有的 257 個樣本**  
✅ 跳過 NAS 已完成的 114 個樣本  
✅ 跳過 ERR/DRR 類型的 235 個樣本

### 時間規劃

⏱️ 初始化（SETUP.bat）: 2-3 分鐘  
⏱️ 完整下載（257 個樣本）: 約 28 小時  
⏱️ 單個樣本平均: 6-7 分鐘

### 系統特性

🔄 **斷點續傳**: 中斷後可繼續  
🧹 **自動清理**: 上傳後刪除本地檔案  
📊 **進度追蹤**: JSON 檔案記錄所有狀態  
☁️ **自動上傳**: 完成即上傳 NAS

---

**準備好了嗎？執行 `.\SETUP.bat` 開始！** 🚀
