# 🚀 SRA 自動下載系統 - 完整使用指南

## 📖 目錄

1. [快速開始](#快速開始)
2. [新環境設置](#新環境設置)
3. [故障排除](#故障排除)
4. [系統說明](#系統說明)
5. [常見問題](#常見問題)

---

## 🎯 快速開始

### 最快啟動 (2 步驟)

```batch
REM 步驟 1: 初始化環境 (自動安裝所有需求)
.\SETUP.bat

REM 步驟 2: 當提示時輸入 Y 立即開始下載
要立即開始下載嗎？ (Y/N): Y
```

**就這樣!系統會自動:**

- ✅ 檢查並安裝 Python 套件
- ✅ 下載/驗證 SRA Toolkit
- ✅ 檢查 NAS 連線
- ✅ 開始下載 257 個樣本

---

## 🆕 新環境設置

### 情況 A: 已有 sratoolkit.3.2.1-win64 資料夾

```batch
REM 1. 解除 Windows 封鎖
.\解除封鎖.bat

REM 2. 初始化並開始
.\SETUP.bat
```

---

### 情況 B: 全新環境 (無 toolkit)

```batch
REM 直接執行 SETUP.bat
.\SETUP.bat

REM 當提示時選擇自動下載:
💡 可以自動從 NCBI 官方下載 SRA Toolkit
   要現在自動下載並安裝嗎？ (Y/N): Y
```

---

## 🔧 故障排除

### 問題 1: prefetch.exe 無法執行

**症狀:**

```
⚠️ 本地 prefetch 無法執行，可能被 Windows 封鎖
```

**解決方案 (3 選 1):**

#### 方案 A: 批次檔解除封鎖 (最簡單)

```batch
.\解除封鎖.bat
```

#### 方案 B: PowerShell 一行指令

```powershell
Get-ChildItem -Path .\sratoolkit.3.2.1-win64 -Recurse -File | Unblock-File
```

#### 方案 C: 重新下載乾淨版本

```batch
.\一鍵安裝_SRA_Toolkit_EN.bat
```

---

### 問題 2: 缺少 Visual C++ Redistributable

**症狀:**

```
prefetch.exe 執行時出現缺少 DLL 錯誤
```

**解決方案:**

```batch
.\安裝_VC++_Redistributable.bat
```

或手動下載: https://aka.ms/vs/17/release/vc_redist.x64.exe

---

### 問題 3: NAS 連接失敗

**症狀:**

```
❌ NAS連接失敗: [WinError 10060] 連線嘗試失敗
```

**檢查步驟:**

1. **測試網路連通性:**

```powershell
Test-NetConnection -ComputerName bioailab.synology.me -Port 22
```

2. **測試詳細連線:**

```batch
python test_nas_connection.py
```

3. **可能原因:**

   - 校園網路需要 VPN
   - 防火牆封鎖 Port 22
   - NAS 伺服器維護中

4. **暫時解決:**
   - 系統會自動繼續下載到本地
   - 稍後可手動上傳到 NAS

---

### 問題 4: PowerShell 腳本編碼錯誤

**症狀:**

```
The string is missing the terminator: ".
The Try statement is missing its Catch or Finally block.
```

**解決方案:**
使用英文版腳本:

```batch
REM 使用英文版安裝腳本
.\一鍵安裝_SRA_Toolkit_EN.bat

REM 使用英文版解除封鎖腳本
powershell -ExecutionPolicy Bypass -File Unblock_SRA_Toolkit.ps1
```

---

## 📊 系統說明

### 目錄結構

```
auto_downloader/
├── SETUP.bat                    # 初始化系統
├── START.bat                    # 啟動下載
├── complete_downloader.py       # 主程序
├── config.py                    # 配置檔案
├── check_environment.py         # 環境檢查
├── nas_uploader.py             # NAS 上傳器
├── runs.txt                     # 樣本清單 (606個)
├── download_progress.json       # 進度記錄
├── sratoolkit.3.2.1-win64/     # SRA Toolkit (可選)
└── downloads/                   # 下載目錄 (自動創建)
```

---

### 系統配置

- **SRR 樣本總數:** 606 個
- **已完成 (NAS):** 114 個 (SRR) + 235 個 (其他)
- **待下載:** 257 個
- **並行下載:** 6 個樣本
- **解壓線程:** 每個樣本 5 線程
- **總線程數:** 30 線程
- **預計時間:** 約 28 小時

---

### 處理流程

```
1. 下載 .sra 檔案
   ↓ (prefetch)

2. 驗證完整性
   ↓ (vdb-validate)

3. 轉換為 FASTQ
   ↓ (fasterq-dump, 5 threads)

4. 上傳到 NAS
   ↓ (SFTP)

5. 清理本地檔案
   ✓
```

---

## ❓ 常見問題

### Q1: 可以在其他電腦上使用嗎?

**A:** 可以!整個 `auto_downloader` 資料夾是獨立的。

- 複製到新電腦
- 確保有 Python 3.7+
- 執行 `.\SETUP.bat`

---

### Q2: 下載中斷了怎麼辦?

**A:** 系統會自動從斷點繼續:

- 進度記錄在 `download_progress.json`
- 已完成的樣本會自動跳過
- 重新執行 `.\START.bat` 即可

---

### Q3: 可以修改並行數量嗎?

**A:** 可以編輯 `complete_downloader.py`:

```python
MAX_CONCURRENT = 6  # 改為你想要的並行數
THREADS = 5         # 改為每個樣本的線程數
```

---

### Q4: 不需要 NAS 上傳可以嗎?

**A:** 可以:

- 檔案會保留在 `downloads/` 目錄
- 系統會正常運作
- 只是不會自動上傳到 NAS

---

### Q5: 如何檢查下載進度?

**A:** 查看 `download_progress.json`:

```json
{
  "SRR123456": {
    "status": "completed",
    "timestamp": "2025-10-20 10:30:00"
  }
}
```

或查看終端輸出的即時進度。

---

## 📞 支援資訊

### 測試工具

```batch
REM 測試 NAS 連線
python test_nas_connection.py

REM 檢查環境
python check_environment.py

REM 測試 SRA Toolkit
.\sratoolkit.3.2.1-win64\bin\prefetch.exe --version
```

---

### 批次工具

| 檔案                            | 功能                      |
| ------------------------------- | ------------------------- |
| `SETUP.bat`                     | 環境初始化 + 可選立即下載 |
| `START.bat`                     | 啟動下載系統              |
| `解除封鎖.bat`                  | 解除 Windows 檔案封鎖     |
| `一鍵安裝_SRA_Toolkit_EN.bat`   | 自動下載安裝 Toolkit      |
| `安裝_VC++_Redistributable.bat` | 安裝 VC++ 運行庫          |

---

### PowerShell 腳本

| 檔案                      | 功能                |
| ------------------------- | ------------------- |
| `Install_SRA_Toolkit.ps1` | 英文版 Toolkit 安裝 |
| `Unblock_SRA_Toolkit.ps1` | 英文版解除封鎖      |
| `copy_sratoolkit.ps1`     | 複製 Toolkit        |

---

## 🎯 推薦工作流程

### 第一次使用

```batch
REM 1. 執行 SETUP
.\SETUP.bat

REM 2. 提示時輸入 Y 立即開始
要立即開始下載嗎？ (Y/N): Y

REM 3. 系統自動運行，可以離開電腦
REM    (預計 28 小時)
```

---

### 在新環境使用

```batch
REM 1. 複製整個 auto_downloader 資料夾
REM 2. 確保 Python 已安裝
python --version

REM 3. 執行 SETUP
.\SETUP.bat

REM 4. 如果有現成 toolkit 需解除封鎖
.\解除封鎖.bat

REM 5. 重新執行 SETUP
.\SETUP.bat
```

---

### 恢復中斷的下載

```batch
REM 直接執行 START，會自動從斷點繼續
.\START.bat
```

---

## 🔐 安全說明

- NAS 憑證已硬編碼在 `check_environment.py`
- NCBI API Key 在 `config.py`
- 建議不要公開分享此資料夾

---

## 📈 效能優化

### I7-11 代 最佳配置:

- 6 並行樣本
- 每樣本 5 線程
- 總計 30 執行緒

### 其他 CPU:

- I5/R5: 4 並行 × 4 線程 = 16 執行緒
- I3/R3: 3 並行 × 3 線程 = 9 執行緒
- I9/R9: 8 並行 × 6 線程 = 48 執行緒

---

## ✅ 檢查清單

- [ ] Python 3.7+ 已安裝
- [ ] auto_downloader 資料夾已準備
- [ ] 執行 `.\SETUP.bat` 完成初始化
- [ ] 所有 5 項檢查都通過
- [ ] 執行 `.\START.bat` 或在 SETUP 時選擇 Y
- [ ] 系統開始下載

---

**就這麼簡單!** 🎉

如有問題,請參考 [故障排除](#故障排除) 章節。
